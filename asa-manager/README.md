[![Build][build-badge]][build-url]
[![Issues][issues-badge]][issues-url]
[![Gitter][gitter-badge]][gitter-url]

Azure Stream Analytics Manager overview
=======================================

This service allows to manage the Azure Stream Analytics (ASA) jobs,
to set the configuration, start, stop, and monitor their status.

The service uses the information manage by PCS Telemetry microservice
to set the stream processing logic, in order to implement monitoring
rules applied to the telemetry generated by IoT Devices.

ASA jobs use a reference table, in order to support device grouping,
i.e. to define monitoring rules on a group of devices. The device
groups are managed by PCS Configuration, using Azure IoT Hub device
twin queries.

Dependencies
============

The service depends on:


* [Azure Stream Analytics][asa-url]
* Azure service account, used to access and manage ASA configuration 
* [PCS Telemetry microservice][telemetry-microservice-url] used to download
  the remote monitoring rules, which are transformed into ASA Jobs logic
* [PCS Configuration microservice][configuration-microservice-url] used
  to download the list of device groups
* Configuration settings to connect to the dependencies. These settings
  are stored in environment variables, which are referenced by the service
  configuration.

How to use the microservice
===========================

## Quickstart - Running the service with Docker

{TODO}

## Running the service with Visual Studio

{TODO}

## Project Structure

{TODO}

## Build and Run from the command line

The [scripts](scripts) folder contains scripts for many frequent tasks:

* `build`: compile all the projects and run the tests.
* `compile`: compile all the projects.
* `run`: compile the projects and run the service. This will prompt for
  elevated privileges in Windows to run the web service.

## Building a customized Docker image

The `scripts` folder includes a [docker](scripts/docker) subfolder with the
scripts required to package the service into a Docker image:

* `Dockerfile`: Docker image specifications
* `build`: build a Docker image and store the image in the local registry
* `run`: run the Docker container from the image stored in the local registry
* `content`: a folder with files copied into the image, including the entry
  point script

You can also start the dependencies in one simple step, using Docker Compose
with the
[docker-compose.yml](scripts/docker/docker-compose.yml) file in the project:

```
cd scripts
cd docker
docker-compose up
```

The Docker compose configuration requires the StorageAdapter web
service URL environment variable, described previously.

## Configuration and Environment variables

The service configuration is stored using ASP.NET Core configuration
adapters, in [appsettings.ini](WebService/appsettings.ini). The INI format
allows to store values in a readable format, with comments. The application
also supports references to environment variables, which is used to import
credentials and networking details.

The configuration files in the repository reference some environment
variables that need to be created at least once. Depending on your OS and
the IDE, there are several ways to manage environment variables:

* Windows: the variables can be set [in the system][windows-envvars-howto-url]
  as a one time only task. The
  [env-vars-setup.cmd](scripts/env-vars-setup.cmd) script included needs to
  be prepared and executed just once. The settings will persist across
  terminal sessions and reboots.
* Visual Studio: the variables can be set in the projects's settings, under
  Project Properties -> Configuration Properties -> Environment
* For Linux and OSX environments, the [env-vars-setup](scripts/env-vars-setup)
  script needs to be executed every time a new console is opened.
  Depending on the OS and terminal, there are ways to persist values
  globally, for more information these pages should help:
  * https://stackoverflow.com/questions/13046624/how-to-permanently-export-a-variable-in-linux
  * https://stackoverflow.com/questions/135688/setting-environment-variables-in-os-x
  * https://help.ubuntu.com/community/EnvironmentVariables

Contributing to the solution
============================

Please follow our [contribution guidelines](docs/CONTRIBUTING.md).  We love PRs too.

Troubleshooting
===============

{TODO}

Feedback
==========

Please enter issues, bugs, or suggestions as GitHub Issues here: 
https://github.com/Azure/asa-manager-dotnet/issues





[build-badge]: https://img.shields.io/travis/Azure/asa-manager-dotnet.svg
[build-url]: https://travis-ci.org/Azure/asa-manager-dotnet
[issues-badge]: https://img.shields.io/github/issues/azure/asa-manager-dotnet.svg
[issues-url]: https://github.com/azure/asa-manager-dotnet/issues
[gitter-badge]: https://img.shields.io/gitter/room/azure/iot-solutions.js.svg
[gitter-url]: https://gitter.im/azure/iot-solutions


[asa-url]: https://azure.microsoft.com/services/stream-analytics
[telemetry-microservice-url]: https://github.com/Azure/device-telemetry-dotnet
[configuration-microservice-url]: https://github.com/azure/pcs-config-dotnet
[postman-url]: https://www.getpostman.com
[vs-install-url]: https://www.visualstudio.com/downloads
[dotnetcore-tools-url]: https://www.microsoft.com/net/core#windowsvs2017
[windows-envvars-howto-url]: https://superuser.com/questions/949560/how-do-i-set-system-environment-variables-in-windows-10
[docker-compose-install-url]: https://docs.docker.com/compose/install
